## ----include = FALSE-------------------------------------------------------------------------------------------------------------------------------------------------
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

## ----setup, message=FALSE--------------------------------------------------------------------------------------------------------------------------------------------
{
library(bayesplot)
library(brms)
library(dplyr)
library(ggplot2)
library(ggdist)
library(grid)
library(tidybayes)
library(tidyr)
library(trps)
library(viridis)
}

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
consumer_iso

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
baseline_1_iso

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
baseline_2_iso

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
consumer_iso_2 <- consumer_iso %>% 
  arrange(ecoregion, common_name) %>% 
  group_by(ecoregion, common_name) %>% 
  mutate(
    id = row_number()
  ) %>% 
  ungroup() %>% 
  dplyr::select(id, common_name:d15n)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
baseline_1_iso_2 <- baseline_1_iso %>% 
  arrange(ecoregion, common_name) %>% 
  group_by(ecoregion, common_name) %>% 
  mutate(
    id = row_number()
  ) %>% 
  ungroup() %>% 
  dplyr::select(id, ecoregion:d15n_b1)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
baseline_2_iso_2 <- baseline_2_iso %>% 
  arrange(ecoregion, common_name) %>% 
  group_by(ecoregion, common_name) %>% 
  mutate(
    id = row_number()
  ) %>% 
  ungroup() %>% 
  dplyr::select(id, ecoregion:d15n_b2)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
combined_iso_ts <- consumer_iso_2 %>% 
  left_join(baseline_1_iso_2, by = c("id", "ecoregion")) %>% 
  left_join(baseline_2_iso_2, by = c("id", "ecoregion")) 

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
combined_iso_ts_1 <- combined_iso_ts %>% 
  group_by(ecoregion, common_name) %>% 
  mutate(
    c1 = mean(d13c_b1, na.rm = TRUE),
    n1 = mean(d15n_b1, na.rm = TRUE),
    c2 = mean(d13c_b2, na.rm = TRUE),
    n2 = mean(d15n_b2, na.rm = TRUE),
    l1 = 2
  ) %>% 
  ungroup()

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
combined_iso_ts_1

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
m <- brm(
  formula = two_source_model(),
  prior = two_source_priors(),
  stanvars = two_source_priors_params(),
  data = combined_iso_ts_1,
  family = gaussian(),
  chains = 2,
  iter = 4000,
  warmup = 1000,
  cores = 4,
  seed = 4,
  control = list(adapt_delta = 0.95)
)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
m

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
plot(m)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
pp_check(m, resp = "d13c")

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
pp_check(m, resp = "d15n")

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
m

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
get_variables(m)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
post_draws <- m %>% 
  gather_draws(b_d13c_alpha_Intercept, b_d15n_tp_Intercept) %>% 
  mutate(
    ecoregion = "Embayment",
    common_name = "Lake Trout",
    .variable = case_when(
      .variable %in% "b_d15n_tp_Intercept" ~ "tp",
      .variable %in% "b_d13c_alpha_Intercept" ~ "alpha"
    )
  ) %>% 
  dplyr::select(common_name, ecoregion, .chain:.value)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
post_draws

## ----message=FALSE---------------------------------------------------------------------------------------------------------------------------------------------------
medians_ci <- m %>%
        gather_draws(b_d13c_alpha_Intercept, 
                     b_d15n_tp_Intercept) %>%
        median_qi() %>% 
  mutate(
    ecoregion = "Embayment", 
    common_name = "Lake Trout", 
    .variable = case_when(
      .variable %in% "b_d15n_tp_Intercept" ~ "tp",
      .variable %in% "b_d13c_alpha_Intercept" ~ "alpha"
    )
  ) %>% 
  mutate_if(is.numeric, round, digits = 2)

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
medians_ci

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(data = post_draws, aes(x = .value)) + 
  geom_density() + 
  facet_wrap(~ .variable, scale = "free") +
  theme_bw(base_size = 15) +
  theme(
    panel.grid = element_blank(), 
    strip.background = element_blank(),
  ) + 
  labs(
    x = "P(Estimate | X)", 
    y = "Density"
  )

## --------------------------------------------------------------------------------------------------------------------------------------------------------------------
ggplot(data = post_draws, aes(y = .value, 
                              x = common_name)) + 
  stat_pointinterval() + 
   facet_wrap(~ .variable, scale = "free") +
  theme_bw(base_size = 15) +
  theme(
    panel.grid = element_blank(), 
    strip.background = element_blank(),
  ) + 
  labs(
    x = "P(Estimate | X)", 
    y = "Density"
  )

