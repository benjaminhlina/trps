---
title: "Estimate trophic position - one-source model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimate trophic position - one-source model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Our Objectives
The purpose of this vignette is to learn how to estimate trophic position of a 
species using a one-source model based on [Post 2002](ttps://esajournals.onlinelibrary.wiley.com/doi/abs/10.1890/0012-9658%282002%29083%5B0703%3AUSITET%5D2.0.CO%3B2). We will use a Bayesian 
framework deployed through [{trps}](https://benjaminhlina.github.io/trps/) and [{brms}](https://paulbuerkner.com/brms/). We will use stable isotope data
($\delta$<sup>13</sup>C and $\delta$<sup>15</sup>N) to estimate trophic position. 

We will need to do a bit of organizing the data prior to running the model. To 
do this work we will use [{dplyr}](https://dplyr.tidyverse.org/) and 
[{tidyr}]() but we could also use [{data.table}](https://rdatatable.gitlab.io/data.table/) 
to do this work. 

When running the model we will use [{trps}](https://benjaminhlina.github.io/trps/) 
and [{brms}](https://paulbuerkner.com/brms/) and iterative processes provided 
by [{purrr}](https://purrr.tidyverse.org/). 

Once we have run the model we will use [{bayesplot}](https://mc-stan.org/bayesplot/) 
to assess models and then extract posterior draws using 
[{bayestestR}](https://easystats.github.io/bayestestR/) and 
[{tidybayes}](http://mjskay.github.io/tidybayes/). 
Posterior distributions will be plotted using [{ggplot2}](https://ggplot2.tidyverse.org/) 
and [{ggdist}](https://mjskay.github.io/ggdist/).

## Load packages 
```{r setup, message=FALSE}
{
  library(bayesplot)
  library(bayestestR)
  library(brms)
  library(dplyr)
  library(ggplot2)
  library(ggdist)
  library(purrr)
  library(tidybayes)
  library(trps)
}
```

## Assess data 

In [{trps}]() we have several data sets, they include stable isotope data
($\delta$<sup>13</sup>C and $\delta$<sup>15</sup>N) for a
consumer, lake trout (), a benthic baseline, amphipods, and a pelagic baseline, 
dreissenids for two ecoregions in Lake Ontario. 

We will check out each data set with the first being the consumer. 
```{r}
consumer_iso
```

We can see that this data set contains the common name of the consumer 
(`common_name`), the ecoregion samples were collected (`ecoregion`) and 
$\delta$<sup>13</sup>C (`d13c`) and $\delta$<sup>15</sup>N (`d15n`). 

Next for this vignette we will only assess benthic baseline data set 

```{r}
baseline_1_iso
```

We can see that this data set contains the common name of the baseline 
(`common_name`), the ecoregion samples were collected (`ecoregion`) and 
$\delta$<sup>13</sup>C (`c1`) and $\delta$<sup>15</sup>N (`n1`). 

## Organizing data 

Now that we understand the data we need to combine the data to estimate 
trophic position for our consumer. To do this we first need to make an `id` 
column in each data set that will assist in joining data. 

Let us first do this to the `consumer_iso` data frame.  

```{r}
consumer_iso <- consumer_iso %>% 
  group_by(common_name, ecoregion) %>% 
  mutate(
    id = row_number()
  ) %>% 
  ungroup() %>% 
  dplyr::select(id, common_name:d15n)
```

Next let us do this to the `baseline_1_iso` data frame. For joining purposes we 
are going to drop `common_name` from this data frame. 

```{r}
baseline_1_iso <- baseline_1_iso %>% 
  group_by(common_name, ecoregion) %>% 
  mutate(
    id = row_number()
  ) %>% 
  ungroup() %>% 
  dplyr::select(id, ecoregion:n1)
```

Now that we have both the consumer and baseline data frames having consistent
structure we can join them to then use in the analysis. We will also add in 
a constant $\lambda$ (`l1`) to our data frame. 

```{r}
combined_iso_os <- consumer_iso %>% 
  left_join(baseline_1_iso, by = c("id", "ecoregion")) %>% 
  mutate(
    l1 = 2
  )
```

We can see that this has successfully combined our consumer and baseline data. 
```{r}
combined_iso_os
```

## Bayesian Analysis

We can now estimate trophic position for lake trout in an ecoregion of
Lake Ontario. 

There are a few things to know about running a Bayesian analysis, I suggest 
reading a these resources. 

Bayesian analyses rely on supplying uninformed or informed prior distributions 
for each parameter (coefficient; predictor) in the model.

Some important things to pay attention to are 
always run at least 2 chains, if the model does not converge you can try 
to adjust the amount of samples that are burned-in (discarded; in brms 
this can be controlled by the argument `warmup`), adjust the number of 
iterative samples retained (in brms this can be controlled by the 
argument `iter`), and/or adjust the `adapt_delta` value using 
`control = list(adapt_delta = 0.95)`. 

When assessing the model we want rhat to be 1 or within 0.05 of 1, we also want 
a high value for effective sample size (ESS), we want trace plots to look 
"grassy" or "catapillery", and we want posterior distrubitons to look relatively
normal. 

## Estimating trophic position 

We will use functions from {trps} that drop into a {brms} model. These 
functions are `one_source_model()` which provides `brm()` the formula structure
needed to run a one-source model. Next is `brm()` needs the structure of the 
priors which can be supplied to the `prior` argument using `one_source_priors()`. 
Lastly, values for these priors are supplied through the `stanvars` argument 
using `one_source_priors_params()`. You can adjust the mean ($\mu$),  
variance ($\sigma$), or upper and lower bounds (`lb` and `ub`) for each prior 
of the model within `one_soruce_priors_params()`, however, only adjust priors 
if you have a good grasp of Bayesian frameworks and your study system and 
species. 

```{r}
m <- brm(
  formula = one_source_model(),
  prior = one_source_priors(),
  stanvars = one_source_priors_params(),
  data = combined_iso_os,
  family = gaussian(),
  chains = 2,
  iter = 4000,
  warmup = 1000,
  cores = 4,
  seed = 4,
  control = list(adapt_delta = 0.95)
)
```

Let us view a summary of the model  

```{r}
m
```

Let us view trace plots and posterior distributions 

```{r}
plot(m)
```

